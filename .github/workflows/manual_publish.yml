name: æ‰‹åŠ¨å‘å¸ƒTwitteræ¨æ–‡

on:
  workflow_dispatch:
    inputs:
      tweet_content:
        description: 'æ¨æ–‡å†…å®¹'
        required: true
        type: string
      target_account:
        description: 'é€‰æ‹©å‘å¸ƒè´¦å·'
        required: true
        type: choice
        options:
          - 'ContextSpace'
          - 'OSS Discoveries'
          - 'Ai flow watch'
          - 'Open source reader'
        default: 'ContextSpace'
      debug_mode:
        description: 'è°ƒè¯•æ¨¡å¼ï¼ˆä¸å®é™…å‘å¸ƒï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  manual-tweet-publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
    
    - name: ğŸ“¦ ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v4
      id: cache-deps
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        pip list
    
    - name: ğŸ” éªŒè¯å…³é”®ä¾èµ–
      run: |
        echo "ğŸ§ª éªŒè¯å…³é”®ä¾èµ–åŒ…..."
        python -c "import tweepy; print('âœ… tweepy - Twitter APIåº“')"
        python -c "import dotenv; print('âœ… python-dotenv - ç¯å¢ƒå˜é‡åŠ è½½åº“')"
        python -c "import requests; print('âœ… requests - HTTPè¯·æ±‚åº“')"
        python -c "import pandas; print('âœ… pandas - æ•°æ®å¤„ç†åº“')"
        python -c "import pytz; print('âœ… pytz - æ—¶åŒºå¤„ç†åº“')"
        echo "ï¿½ï¿½ æ‰€æœ‰å…³é”®ä¾èµ–éªŒè¯é€šè¿‡ï¼"
    
    - name: ğŸ“ æ˜¾ç¤ºå‘å¸ƒä¿¡æ¯
      run: |
        echo "ğŸš€ å‡†å¤‡æ‰‹åŠ¨å‘å¸ƒæ¨æ–‡"
        echo "ğŸ“„ æ¨æ–‡å†…å®¹: ${{ github.event.inputs.tweet_content }}"
        echo "ğŸ“± ç›®æ ‡è´¦å·: ${{ github.event.inputs.target_account }}"
        echo "ğŸ› è°ƒè¯•æ¨¡å¼: ${{ github.event.inputs.debug_mode }}"
        echo "â° æ‰§è¡Œæ—¶é—´: $(date)"
        
        # æ£€æŸ¥æ¨æ–‡é•¿åº¦
        content_length=$(echo "${{ github.event.inputs.tweet_content }}" | wc -c)
        echo "ğŸ“Š æ¨æ–‡é•¿åº¦: ${content_length} å­—ç¬¦"
        
        if [ $content_length -gt 280 ]; then
          echo "âŒ é”™è¯¯ï¼šæ¨æ–‡å†…å®¹è¶…è¿‡280å­—ç¬¦é™åˆ¶"
          exit 1
        fi
    
    - name: ğŸ” è°ƒè¯•è´¦å·é…ç½®
      env:
        # ContextSpaceä¸»è´¦å·
        TWITTER_CONTEXTSPACE_CONSUMER_KEY: ${{ secrets.TWITTER_CONTEXTSPACE_CONSUMER_KEY }}
        TWITTER_CONTEXTSPACE_CONSUMER_SECRET: ${{ secrets.TWITTER_CONTEXTSPACE_CONSUMER_SECRET }}
        TWITTER_CONTEXTSPACE_ACCESS_TOKEN: ${{ secrets.TWITTER_CONTEXTSPACE_ACCESS_TOKEN }}
        TWITTER_CONTEXTSPACE_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_CONTEXTSPACE_ACCESS_TOKEN_SECRET }}
        TWITTER_CONTEXTSPACE_BEARER_TOKEN: ${{ secrets.TWITTER_CONTEXTSPACE_BEARER_TOKEN }}
        
        # OSS Discoveriesè´¦å·
        TWITTER_OSSDISCOVERIES_CONSUMER_KEY: ${{ secrets.TWITTER_OSSDISCOVERIES_CONSUMER_KEY }}
        TWITTER_OSSDISCOVERIES_CONSUMER_SECRET: ${{ secrets.TWITTER_OSSDISCOVERIES_CONSUMER_SECRET }}
        TWITTER_OSSDISCOVERIES_ACCESS_TOKEN: ${{ secrets.TWITTER_OSSDISCOVERIES_ACCESS_TOKEN }}
        TWITTER_OSSDISCOVERIES_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_OSSDISCOVERIES_ACCESS_TOKEN_SECRET }}
        TWITTER_OSSDISCOVERIES_BEARER_TOKEN: ${{ secrets.TWITTER_OSSDISCOVERIES_BEARER_TOKEN }}
        
        # AI Flow Watchè´¦å·
        TWITTER_AIFLOWWATCH_CONSUMER_KEY: ${{ secrets.TWITTER_AIFLOWWATCH_CONSUMER_KEY }}
        TWITTER_AIFLOWWATCH_CONSUMER_SECRET: ${{ secrets.TWITTER_AIFLOWWATCH_CONSUMER_SECRET }}
        TWITTER_AIFLOWWATCH_ACCESS_TOKEN: ${{ secrets.TWITTER_AIFLOWWATCH_ACCESS_TOKEN }}
        TWITTER_AIFLOWWATCH_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_AIFLOWWATCH_ACCESS_TOKEN_SECRET }}
        TWITTER_AIFLOWWATCH_BEARER_TOKEN: ${{ secrets.TWITTER_AIFLOWWATCH_BEARER_TOKEN }}
        
        # Open Source Readerè´¦å·
        TWITTER_OPENSOURCEREADER_CONSUMER_KEY: ${{ secrets.TWITTER_OPENSOURCEREADER_CONSUMER_KEY }}
        TWITTER_OPENSOURCEREADER_CONSUMER_SECRET: ${{ secrets.TWITTER_OPENSOURCEREADER_CONSUMER_SECRET }}
        TWITTER_OPENSOURCEREADER_ACCESS_TOKEN: ${{ secrets.TWITTER_OPENSOURCEREADER_ACCESS_TOKEN }}
        TWITTER_OPENSOURCEREADER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_OPENSOURCEREADER_ACCESS_TOKEN_SECRET }}
        TWITTER_OPENSOURCEREADER_BEARER_TOKEN: ${{ secrets.TWITTER_OPENSOURCEREADER_BEARER_TOKEN }}
      run: |
        echo "ğŸ” è°ƒè¯•è´¦å·é…ç½®çŠ¶æ€..."
        python debug_github_actions.py
        
        echo "ğŸ§ª æµ‹è¯•ç›®æ ‡è´¦å·è¿æ¥..."
        python connect_twitter_multi.py
    
    - name: ğŸš€ æ‰§è¡Œæ‰‹åŠ¨æ¨æ–‡å‘å¸ƒ
      env:
        # ContextSpaceä¸»è´¦å·
        TWITTER_CONTEXTSPACE_CONSUMER_KEY: ${{ secrets.TWITTER_CONTEXTSPACE_CONSUMER_KEY }}
        TWITTER_CONTEXTSPACE_CONSUMER_SECRET: ${{ secrets.TWITTER_CONTEXTSPACE_CONSUMER_SECRET }}
        TWITTER_CONTEXTSPACE_ACCESS_TOKEN: ${{ secrets.TWITTER_CONTEXTSPACE_ACCESS_TOKEN }}
        TWITTER_CONTEXTSPACE_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_CONTEXTSPACE_ACCESS_TOKEN_SECRET }}
        TWITTER_CONTEXTSPACE_BEARER_TOKEN: ${{ secrets.TWITTER_CONTEXTSPACE_BEARER_TOKEN }}
        
        # OSS Discoveriesè´¦å·
        TWITTER_OSSDISCOVERIES_CONSUMER_KEY: ${{ secrets.TWITTER_OSSDISCOVERIES_CONSUMER_KEY }}
        TWITTER_OSSDISCOVERIES_CONSUMER_SECRET: ${{ secrets.TWITTER_OSSDISCOVERIES_CONSUMER_SECRET }}
        TWITTER_OSSDISCOVERIES_ACCESS_TOKEN: ${{ secrets.TWITTER_OSSDISCOVERIES_ACCESS_TOKEN }}
        TWITTER_OSSDISCOVERIES_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_OSSDISCOVERIES_ACCESS_TOKEN_SECRET }}
        TWITTER_OSSDISCOVERIES_BEARER_TOKEN: ${{ secrets.TWITTER_OSSDISCOVERIES_BEARER_TOKEN }}
        
        # AI Flow Watchè´¦å·
        TWITTER_AIFLOWWATCH_CONSUMER_KEY: ${{ secrets.TWITTER_AIFLOWWATCH_CONSUMER_KEY }}
        TWITTER_AIFLOWWATCH_CONSUMER_SECRET: ${{ secrets.TWITTER_AIFLOWWATCH_CONSUMER_SECRET }}
        TWITTER_AIFLOWWATCH_ACCESS_TOKEN: ${{ secrets.TWITTER_AIFLOWWATCH_ACCESS_TOKEN }}
        TWITTER_AIFLOWWATCH_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_AIFLOWWATCH_ACCESS_TOKEN_SECRET }}
        TWITTER_AIFLOWWATCH_BEARER_TOKEN: ${{ secrets.TWITTER_AIFLOWWATCH_BEARER_TOKEN }}
        
        # Open Source Readerè´¦å·
        TWITTER_OPENSOURCEREADER_CONSUMER_KEY: ${{ secrets.TWITTER_OPENSOURCEREADER_CONSUMER_KEY }}
        TWITTER_OPENSOURCEREADER_CONSUMER_SECRET: ${{ secrets.TWITTER_OPENSOURCEREADER_CONSUMER_SECRET }}
        TWITTER_OPENSOURCEREADER_ACCESS_TOKEN: ${{ secrets.TWITTER_OPENSOURCEREADER_ACCESS_TOKEN }}
        TWITTER_OPENSOURCEREADER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_OPENSOURCEREADER_ACCESS_TOKEN_SECRET }}
        TWITTER_OPENSOURCEREADER_BEARER_TOKEN: ${{ secrets.TWITTER_OPENSOURCEREADER_BEARER_TOKEN }}
      run: |
        if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
          python manual_publish.py --content "${{ github.event.inputs.tweet_content }}" --account "${{ github.event.inputs.target_account }}" --debug
        else
          python manual_publish.py --content "${{ github.event.inputs.tweet_content }}" --account "${{ github.event.inputs.target_account }}"
        fi
    
    - name: ğŸ“Š ä¸Šä¼ æ‰§è¡Œæ—¥å¿—
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: manual-publish-logs-${{ github.run_number }}
        path: |
          manual_publish.log
          twitter_multi_auto.log
          *.log
        retention-days: 3
    
    - name: ğŸ“‹ å‘å¸ƒç»“æœæ€»ç»“
      if: always()
      run: |
        echo "ğŸ“‹ æ‰‹åŠ¨å‘å¸ƒç»“æœæ€»ç»“"
        echo "========================"
        echo "ğŸ“„ æ¨æ–‡å†…å®¹: ${{ github.event.inputs.tweet_content }}"
        echo "ğŸ“± ç›®æ ‡è´¦å·: ${{ github.event.inputs.target_account }}"
        echo "ğŸ› è°ƒè¯•æ¨¡å¼: ${{ github.event.inputs.debug_mode }}"
        echo "â° æ‰§è¡Œæ—¶é—´: $(date)"
        echo "========================"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… æ‰‹åŠ¨å‘å¸ƒä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ æ‰‹åŠ¨å‘å¸ƒä»»åŠ¡æ‰§è¡Œå¤±è´¥"
        fi 