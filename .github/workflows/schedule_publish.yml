name: å››è´¦å·Twitteræ¯æ—¥è‡ªåŠ¨å‘å¸ƒ

on:
  schedule:
    # æ¯å¤©4æ¬¡è‡ªåŠ¨å‘å¸ƒ - åŒ—äº¬æ—¶é—´ 6:00, 12:00, 18:00, 24:00
    - cron: '0 22,4,10,16 * * *'  # UTCæ—¶é—´ 22:00, 4:00, 10:00, 16:00
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  auto-publish-twitter:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
    
    - name: ğŸ“¦ ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v4
      id: cache-deps
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        pip list
    
    - name: ğŸ” éªŒè¯å…³é”®ä¾èµ–
      run: |
        echo "ğŸ§ª éªŒè¯å…³é”®ä¾èµ–åŒ…..."
        python -c "import tweepy; print('âœ… tweepy - Twitter APIåº“')"
        python -c "import dotenv; print('âœ… python-dotenv - ç¯å¢ƒå˜é‡åŠ è½½åº“')"
        python -c "import requests; print('âœ… requests - HTTPè¯·æ±‚åº“')"
        python -c "import pytz; print('âœ… pytz - æ—¶åŒºå¤„ç†åº“')"
        echo "ğŸ‰ æ‰€æœ‰å…³é”®ä¾èµ–éªŒè¯é€šè¿‡ï¼"
    
    - name: ğŸ“„ æ£€æŸ¥å†…å®¹æ–‡ä»¶
      run: |
        echo "ğŸ“Š æ£€æŸ¥contentæ–‡ä»¶å¤¹ï¼š"
        ls -la content/
        if [ -f content/*.csv ]; then
          echo "âœ… CSVæ–‡ä»¶å­˜åœ¨"
          wc -l content/*.csv
        else
          echo "âŒ æœªæ‰¾åˆ°CSVæ–‡ä»¶"
          exit 1
        fi
    
    - name: ğŸ”— æµ‹è¯•å››è´¦å·è¿æ¥
      env:
        # ContextSpaceä¸»è´¦å·
        TWITTER_CONTEXTSPACE_CONSUMER_KEY: ${{ secrets.TWITTER_CONTEXTSPACE_CONSUMER_KEY }}
        TWITTER_CONTEXTSPACE_CONSUMER_SECRET: ${{ secrets.TWITTER_CONTEXTSPACE_CONSUMER_SECRET }}
        TWITTER_CONTEXTSPACE_ACCESS_TOKEN: ${{ secrets.TWITTER_CONTEXTSPACE_ACCESS_TOKEN }}
        TWITTER_CONTEXTSPACE_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_CONTEXTSPACE_ACCESS_TOKEN_SECRET }}
        TWITTER_CONTEXTSPACE_BEARER_TOKEN: ${{ secrets.TWITTER_CONTEXTSPACE_BEARER_TOKEN }}
        
        # OSS Discoveriesè´¦å·
        TWITTER_OSSDISCOVERIES_CONSUMER_KEY: ${{ secrets.TWITTER_OSSDISCOVERIES_CONSUMER_KEY }}
        TWITTER_OSSDISCOVERIES_CONSUMER_SECRET: ${{ secrets.TWITTER_OSSDISCOVERIES_CONSUMER_SECRET }}
        TWITTER_OSSDISCOVERIES_ACCESS_TOKEN: ${{ secrets.TWITTER_OSSDISCOVERIES_ACCESS_TOKEN }}
        TWITTER_OSSDISCOVERIES_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_OSSDISCOVERIES_ACCESS_TOKEN_SECRET }}
        TWITTER_OSSDISCOVERIES_BEARER_TOKEN: ${{ secrets.TWITTER_OSSDISCOVERIES_BEARER_TOKEN }}
        
        # AI Flow Watchè´¦å·
        TWITTER_AIFLOWWATCH_CONSUMER_KEY: ${{ secrets.TWITTER_AIFLOWWATCH_CONSUMER_KEY }}
        TWITTER_AIFLOWWATCH_CONSUMER_SECRET: ${{ secrets.TWITTER_AIFLOWWATCH_CONSUMER_SECRET }}
        TWITTER_AIFLOWWATCH_ACCESS_TOKEN: ${{ secrets.TWITTER_AIFLOWWATCH_ACCESS_TOKEN }}
        TWITTER_AIFLOWWATCH_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_AIFLOWWATCH_ACCESS_TOKEN_SECRET }}
        TWITTER_AIFLOWWATCH_BEARER_TOKEN: ${{ secrets.TWITTER_AIFLOWWATCH_BEARER_TOKEN }}
        
        # Open Source Readerè´¦å·
        TWITTER_OPENSOURCEREADER_CONSUMER_KEY: ${{ secrets.TWITTER_OPENSOURCEREADER_CONSUMER_KEY }}
        TWITTER_OPENSOURCEREADER_CONSUMER_SECRET: ${{ secrets.TWITTER_OPENSOURCEREADER_CONSUMER_SECRET }}
        TWITTER_OPENSOURCEREADER_ACCESS_TOKEN: ${{ secrets.TWITTER_OPENSOURCEREADER_ACCESS_TOKEN }}
        TWITTER_OPENSOURCEREADER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_OPENSOURCEREADER_ACCESS_TOKEN_SECRET }}
        TWITTER_OPENSOURCEREADER_BEARER_TOKEN: ${{ secrets.TWITTER_OPENSOURCEREADER_BEARER_TOKEN }}
        
        # å…¶ä»–é…ç½®
        DEBUG: ${{ github.event.inputs.debug_mode || 'false' }}
      run: |
        echo "ğŸ§ª æµ‹è¯•å››è´¦å·è¿æ¥..."
        python connect_twitter_multi.py
    
    - name: ğŸš€ æ‰§è¡Œå››è´¦å·è‡ªåŠ¨å‘å¸ƒ
      env:
        # ContextSpaceä¸»è´¦å·
        TWITTER_CONTEXTSPACE_CONSUMER_KEY: ${{ secrets.TWITTER_CONTEXTSPACE_CONSUMER_KEY }}
        TWITTER_CONTEXTSPACE_CONSUMER_SECRET: ${{ secrets.TWITTER_CONTEXTSPACE_CONSUMER_SECRET }}
        TWITTER_CONTEXTSPACE_ACCESS_TOKEN: ${{ secrets.TWITTER_CONTEXTSPACE_ACCESS_TOKEN }}
        TWITTER_CONTEXTSPACE_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_CONTEXTSPACE_ACCESS_TOKEN_SECRET }}
        TWITTER_CONTEXTSPACE_BEARER_TOKEN: ${{ secrets.TWITTER_CONTEXTSPACE_BEARER_TOKEN }}
        
        # OSS Discoveriesè´¦å·
        TWITTER_OSSDISCOVERIES_CONSUMER_KEY: ${{ secrets.TWITTER_OSSDISCOVERIES_CONSUMER_KEY }}
        TWITTER_OSSDISCOVERIES_CONSUMER_SECRET: ${{ secrets.TWITTER_OSSDISCOVERIES_CONSUMER_SECRET }}
        TWITTER_OSSDISCOVERIES_ACCESS_TOKEN: ${{ secrets.TWITTER_OSSDISCOVERIES_ACCESS_TOKEN }}
        TWITTER_OSSDISCOVERIES_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_OSSDISCOVERIES_ACCESS_TOKEN_SECRET }}
        TWITTER_OSSDISCOVERIES_BEARER_TOKEN: ${{ secrets.TWITTER_OSSDISCOVERIES_BEARER_TOKEN }}
        
        # AI Flow Watchè´¦å·
        TWITTER_AIFLOWWATCH_CONSUMER_KEY: ${{ secrets.TWITTER_AIFLOWWATCH_CONSUMER_KEY }}
        TWITTER_AIFLOWWATCH_CONSUMER_SECRET: ${{ secrets.TWITTER_AIFLOWWATCH_CONSUMER_SECRET }}
        TWITTER_AIFLOWWATCH_ACCESS_TOKEN: ${{ secrets.TWITTER_AIFLOWWATCH_ACCESS_TOKEN }}
        TWITTER_AIFLOWWATCH_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_AIFLOWWATCH_ACCESS_TOKEN_SECRET }}
        TWITTER_AIFLOWWATCH_BEARER_TOKEN: ${{ secrets.TWITTER_AIFLOWWATCH_BEARER_TOKEN }}
        
        # Open Source Readerè´¦å·
        TWITTER_OPENSOURCEREADER_CONSUMER_KEY: ${{ secrets.TWITTER_OPENSOURCEREADER_CONSUMER_KEY }}
        TWITTER_OPENSOURCEREADER_CONSUMER_SECRET: ${{ secrets.TWITTER_OPENSOURCEREADER_CONSUMER_SECRET }}
        TWITTER_OPENSOURCEREADER_ACCESS_TOKEN: ${{ secrets.TWITTER_OPENSOURCEREADER_ACCESS_TOKEN }}
        TWITTER_OPENSOURCEREADER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_OPENSOURCEREADER_ACCESS_TOKEN_SECRET }}
        TWITTER_OPENSOURCEREADER_BEARER_TOKEN: ${{ secrets.TWITTER_OPENSOURCEREADER_BEARER_TOKEN }}
        
        # å…¶ä»–é…ç½®
        DEBUG: ${{ github.event.inputs.debug_mode || 'false' }}
      run: |
        echo "ğŸš€ å¼€å§‹å››è´¦å·è‡ªåŠ¨å‘å¸ƒä»»åŠ¡..."
        echo "â° å½“å‰æ—¶é—´: $(date)"
        echo "ğŸŒ UTCæ—¶é—´: $(date -u)"
        python main_multi_account.py
        echo "âœ… å››è´¦å·å‘å¸ƒä»»åŠ¡å®Œæˆ"
    
    - name: ğŸ’¾ æäº¤æ›´æ–°çš„å†…å®¹æ–‡ä»¶
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add content/
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰å†…å®¹æ–‡ä»¶æ›´æ–°"
        else
          git commit -m "ğŸ¤– å››è´¦å·è‡ªåŠ¨å‘å¸ƒæ›´æ–° - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… å†…å®¹æ–‡ä»¶æ›´æ–°å·²æäº¤"
        fi
    
    - name: ğŸ“Š ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: twitter-multi-logs-${{ github.run_number }}
        path: |
          twitter_multi_auto.log
          *.log
        retention-days: 7 