name: Twitterè‡ªåŠ¨å‘å¸ƒ - CSVæ•°æ®æºç‰ˆæœ¬

on:
  # å®šæ—¶è§¦å‘: æ¯å¤©8:00, 14:00, 20:00 (UTCæ—¶é—´)
  schedule:
    - cron: '0 8,14,20 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'è°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean

env:
  PYTHONIOENCODING: utf-8

jobs:
  publish-to-twitter:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” éªŒè¯æ–‡ä»¶ç»“æ„
      run: |
        echo "ğŸ“‚ æ£€æŸ¥æ–‡ä»¶ç»“æ„..."
        ls -la
        echo "ğŸ“„ æ£€æŸ¥CSVæ–‡ä»¶..."
        if [ -f "content_data.csv" ]; then
          echo "âœ… CSVæ•°æ®æ–‡ä»¶å­˜åœ¨"
          head -5 content_data.csv
        else
          echo "âš ï¸ CSVæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åœ¨è¿è¡Œæ—¶åˆ›å»º"
        fi
        
    - name: ğŸ”§ æ£€æŸ¥Pythonæ¨¡å—
      run: |
        echo "ğŸ æ£€æŸ¥Pythonæ¨¡å—..."
        python -c "import connect_twitter; print('âœ… Twitteræ¨¡å—æ­£å¸¸')"
        python -c "import connect_csv; print('âœ… CSVæ¨¡å—æ­£å¸¸')"
        
    - name: ğŸš€ æ‰§è¡ŒTwitterè‡ªåŠ¨å‘å¸ƒ
      env:
        # Twitter APIå‡­è¯
        TWITTER_CONSUMER_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
        TWITTER_CONSUMER_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        
        # è°ƒè¯•æ¨¡å¼
        DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
        
      run: |
        echo "ğŸ¯ å¼€å§‹æ‰§è¡ŒTwitterè‡ªåŠ¨å‘å¸ƒä»»åŠ¡..."
        echo "â° æ‰§è¡Œæ—¶é—´: $(date -u)"
        echo "ğŸŒ æ—¶åŒº: UTC"
        echo "ğŸ”§ Pythonç‰ˆæœ¬: $(python --version)"
        
        if [ "$DEBUG_MODE" = "true" ]; then
          echo "ğŸ› è°ƒè¯•æ¨¡å¼å·²å¯ç”¨"
          python -u main_csv.py --verbose
        else
          python -u main_csv.py
        fi
        
    - name: ğŸ“Š å‘å¸ƒç»“æœç»Ÿè®¡
      if: always()
      run: |
        echo "ğŸ“Š å‘å¸ƒä»»åŠ¡ç»Ÿè®¡..."
        
        # æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
        if [ -f "twitter_publish.log" ]; then
          echo "ğŸ“ æœ€æ–°æ—¥å¿— (æœ€å10è¡Œ):"
          tail -10 twitter_publish.log
          
          echo ""
          echo "ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯:"
          echo "æˆåŠŸå‘å¸ƒæ•°: $(grep -c "æˆåŠŸå‘å¸ƒæ¨æ–‡" twitter_publish.log || echo "0")"
          echo "é”™è¯¯æ¬¡æ•°: $(grep -c "ERROR" twitter_publish.log || echo "0")"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶"
        fi
        
        # æ£€æŸ¥CSVæ–‡ä»¶çŠ¶æ€
        if [ -f "content_data.csv" ]; then
          echo ""
          echo "ğŸ“‹ CSVæ–‡ä»¶çŠ¶æ€:"
          python -c "from connect_csv import CSVDataSource; csv_source = CSVDataSource(); stats = csv_source.get_statistics(); print('æ€»å†…å®¹æ•°:', stats['total']); print('å·²å‘å¸ƒ:', stats['published']); print('å¾…å‘å¸ƒ:', stats['unpublished'])"
        fi
        
    - name: ğŸ’¾ ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: twitter-publish-logs
        path: |
          twitter_publish.log
          content_data.csv
        retention-days: 30
        
    - name: ğŸ”” å‘é€é€šçŸ¥ (å¤±è´¥æ—¶)
      if: failure()
      run: |
        echo "âŒ Twitterå‘å¸ƒä»»åŠ¡å¤±è´¥!"
        echo "â° å¤±è´¥æ—¶é—´: $(date -u)"
        echo "ğŸ” è¯·æ£€æŸ¥æ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        
    - name: âœ… ä»»åŠ¡å®Œæˆ
      if: success()
      run: |
        echo "ğŸ‰ Twitterè‡ªåŠ¨å‘å¸ƒä»»åŠ¡æ‰§è¡Œå®Œæˆ!"
        echo "â° å®Œæˆæ—¶é—´: $(date -u)"
        echo "ğŸ“… ä¸‹æ¬¡æ‰§è¡Œ: æ ¹æ®cronè°ƒåº¦ (8:00, 14:00, 20:00 UTC)" 