name: ä»£ç æ£€æŸ¥å’Œæµ‹è¯•

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
    
    - name: ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v4
      id: cache-deps
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-ci-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-ci-
          ${{ runner.os }}-pip-
    
    - name: å®‰è£…ä¾èµ– (ä»…åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶)
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        echo "ğŸ”„ ç¼“å­˜æœªå‘½ä¸­ï¼Œå®‰è£…ä¾èµ–..."
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        pip install --no-cache-dir flake8 pytest
    
    - name: ä½¿ç”¨ç¼“å­˜ä¾èµ–
      if: steps.cache-deps.outputs.cache-hit == 'true'
      run: |
        echo "âš¡ ä½¿ç”¨ç¼“å­˜ä¾èµ–ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤"
        pip list
    
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        # æ£€æŸ¥Pythonä»£ç æ ¼å¼
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # æ£€æŸ¥ä»£ç é£æ ¼ï¼ˆè­¦å‘Šï¼‰
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: è¯­æ³•æ£€æŸ¥
      run: |
        # æ£€æŸ¥Pythonè¯­æ³•
        python -m py_compile main.py
        python -m py_compile connect_twitter.py
        python -m py_compile main_multi_account.py
        python -m py_compile main_csv.py
        python -m py_compile main_content_folder.py
        python -m py_compile connect_csv.py
        python -m py_compile show_content_source.py
    
    - name: å¯¼å…¥æµ‹è¯•
      run: |
        # æµ‹è¯•æ¨¡å—å¯¼å…¥
        python -c "import connect_twitter; print('connect_twitter.py å¯¼å…¥æˆåŠŸ')"
        python -c "import connect_csv; print('connect_csv.py å¯¼å…¥æˆåŠŸ')"
        python -c "import main_multi_account; print('main_multi_account.py å¯¼å…¥æˆåŠŸ')"
        python -c "import main_csv; print('main_csv.py å¯¼å…¥æˆåŠŸ')"
        python -c "import main_content_folder; print('main_content_folder.py å¯¼å…¥æˆåŠŸ')"
    
    - name: é…ç½®æ–‡ä»¶æ£€æŸ¥
      run: |
        # æ£€æŸ¥é…ç½®æ–‡ä»¶ç¤ºä¾‹
        if [ -f "config.env.example" ]; then
          echo "âœ… é…ç½®æ–‡ä»¶ç¤ºä¾‹å­˜åœ¨"
        else
          echo "âŒ é…ç½®æ–‡ä»¶ç¤ºä¾‹ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ£€æŸ¥requirements.txt
        if [ -f "requirements.txt" ]; then
          echo "âœ… ä¾èµ–æ–‡ä»¶å­˜åœ¨"
        else
          echo "âŒ ä¾èµ–æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ£€æŸ¥contentç›®å½•
        if [ -d "content" ]; then
          echo "âœ… contentç›®å½•å­˜åœ¨"
        else
          echo "âŒ contentç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi 